# ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram Webhook

## –û–±–∑–æ—Ä

–ù–∞—á–∏–Ω–∞—è —Å —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏, Telegram webhook **–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞. –ë–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –∑–∞–ø—É—Å–∫–∞—Ç—å —Å–∫—Ä–∏–ø—Ç—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –¥–µ–ø–ª–æ—è!

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **–ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞** (–ø–æ—Å–ª–µ `npm start` –∏–ª–∏ `pm2 start`)
2. Backend –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `AUTO_SETUP_WEBHOOK`
3. –ï—Å–ª–∏ `AUTO_SETUP_WEBHOOK=true`, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–µ–∫—É—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é webhook
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç webhook –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
   - –õ–æ–≥–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –î–æ–±–∞–≤—å—Ç–µ –≤ `.env`:

```env
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ webhook –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞
AUTO_SETUP_WEBHOOK=true

# –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è webhook
TELEGRAM_BOT_TOKEN=7123456789:AAF...
TELEGRAM_MANAGER_ID=123456789
BACKEND_URL=https://yourdomain.com
```

### 2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä:

```bash
# Development
npm run dev

# Production
npm start
# –∏–ª–∏
pm2 start ecosystem.config.js
```

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:

```bash
pm2 logs backend
```

–í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
```
‚úÖ Webhook auto-configured successfully
üîó URL: https://yourdomain.com/messages/webhook
```

## –í–∞—Ä–∏–∞–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è production)

```env
AUTO_SETUP_WEBHOOK=true
```

**–ü–ª—é—Å—ã:**
- ‚úÖ Webhook –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ
- ‚úÖ –ù–µ –Ω—É–∂–Ω–æ –ø–æ–º–Ω–∏—Ç—å –æ —Ä—É—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–µ
- ‚úÖ –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è CI/CD –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –¥–µ–ø–ª–æ–µ–≤

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- Production –æ–∫—Ä—É–∂–µ–Ω–∏–µ
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π
- –ö–æ–≥–¥–∞ BACKEND_URL —Å—Ç–∞–±–∏–ª–µ–Ω

### –í–∞—Ä–∏–∞–Ω—Ç 2: –†—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ (–¥–ª—è development)

```env
AUTO_SETUP_WEBHOOK=false
# –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–µ —É–∫–∞–∑—ã–≤–∞–π—Ç–µ —ç—Ç—É –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
```

**–ü–ª—é—Å—ã:**
- ‚úÖ –ë–æ–ª—å—à–µ –∫–æ–Ω—Ç—Ä–æ–ª—è –Ω–∞–¥ –ø—Ä–æ—Ü–µ—Å—Å–æ–º
- ‚úÖ –ù–µ –±—É–¥–µ—Ç –ø–µ—Ä–µ–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å webhook –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –≤ dev

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**
- Local development
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å ngrok
- –ö–æ–≥–¥–∞ —á–∞—Å—Ç–æ –º–µ–Ω—è–µ—Ç—Å—è BACKEND_URL

–î–ª—è —Ä—É—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:
```bash
npm run webhook:setup
```

## Health Check

Endpoint `/health` —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å webhook:

```bash
curl https://yourdomain.com/health
```

–û—Ç–≤–µ—Ç:
```json
{
  "status": "ok",
  "timestamp": 1234567890,
  "webhook": {
    "configured": true,
    "hasErrors": false,
    "pendingUpdates": 0
  }
}
```

## –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞:

1. **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —É—Å–ª–æ–≤–∏—è:**
   - `AUTO_SETUP_WEBHOOK=true`
   - `TELEGRAM_BOT_TOKEN` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
   - `BACKEND_URL` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –Ω–µ localhost

2. **–ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å webhook**

3. **–ï—Å–ª–∏ webhook —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ:**
   - –õ–æ–≥–∏—Ä—É–µ—Ç —É—Å–ø–µ—Ö
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
   - –ù–∏—á–µ–≥–æ –Ω–µ –º–µ–Ω—è–µ—Ç

4. **–ï—Å–ª–∏ webhook –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–ª–∏ URL –∏–∑–º–µ–Ω–∏–ª—Å—è:**
   - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–π webhook
   - –õ–æ–≥–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç

## –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –≤ development

–ï—Å–ª–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç–µ –ª–æ–∫–∞–ª—å–Ω–æ –∏ –Ω–µ —Ö–æ—Ç–∏—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É:

```env
# –í backend/.env
AUTO_SETUP_WEBHOOK=false
```

–ò–ª–∏ –ø—Ä–æ—Å—Ç–æ —É–±–µ—Ä–∏—Ç–µ —ç—Ç—É —Å—Ç—Ä–æ–∫—É –∏–∑ `.env`.

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ **–Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è** –µ—Å–ª–∏:
- `BACKEND_URL` —Å–æ–¥–µ—Ä–∂–∏—Ç `localhost` –∏–ª–∏ `127.0.0.1`
- `TELEGRAM_BOT_TOKEN` –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- `BACKEND_URL` –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

–≠—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç —Å–ª—É—á–∞–π–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ webhook –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å.

## –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### Webhook –Ω–µ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**

1. –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –≤–∫–ª—é—á–µ–Ω–∞:
   ```bash
   grep AUTO_SETUP_WEBHOOK backend/.env
   # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: AUTO_SETUP_WEBHOOK=true
   ```

2. –î—Ä—É–≥–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:
   ```bash
   grep TELEGRAM_BOT_TOKEN backend/.env
   grep BACKEND_URL backend/.env
   ```

3. –õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞:
   ```bash
   pm2 logs backend | grep webhook
   ```

### "BACKEND_URL points to localhost"

–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è development. –ò–∑–º–µ–Ω–∏—Ç–µ –Ω–∞ –ø—É–±–ª–∏—á–Ω—ã–π URL:
```env
BACKEND_URL=https://yourdomain.com
```

–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ngrok –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
```bash
ngrok http 4000
# –ó–∞—Ç–µ–º –æ–±–Ω–æ–≤–∏—Ç–µ BACKEND_URL –Ω–∞ ngrok URL
```

### "Failed to auto-configure webhook"

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
1. Backend –µ—â–µ –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
2. –ü—Ä–æ–±–ª–µ–º—ã —Å SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º
3. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –±–æ—Ç–∞

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
curl https://yourdomain.com/health

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ webhook –≤—Ä—É—á–Ω—É—é
npm run webhook:info

# –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤—Ä—É—á–Ω—É—é
npm run webhook:setup
```

## Post-deploy —Å–∫—Ä–∏–ø—Ç—ã

–¢–∞–∫–∂–µ –¥–æ—Å—Ç—É–ø–Ω—ã post-deploy —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏:

```bash
# Linux/Mac
bash scripts/post-deploy.sh

# Windows
.\scripts\post-deploy.ps1
```

–û–Ω–∏:
- –ü—Ä–æ–≤–µ—Ä—è—é—Ç –Ω–∞–ª–∏—á–∏–µ `.env`
- –ü—Ä–æ–≤–µ—Ä—è—é—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å backend
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç webhook (–µ—Å–ª–∏ `AUTO_SETUP_WEBHOOK!=true`)
- –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç —Å—Ç–∞—Ç—É—Å

## PM2 Integration

–í `ecosystem.config.js` –Ω–∞—Å—Ç—Ä–æ–µ–Ω post-update hook:

```javascript
post_update: ['bash scripts/post-deploy.sh']
```

–ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —á–µ—Ä–µ–∑ PM2 –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è post-deploy —Å–∫—Ä–∏–ø—Ç.

## –ü—Ä–∏–º–µ—Ä—ã

### –ü—Ä–∏–º–µ—Ä 1: Production –¥–µ–ø–ª–æ–π —Å –∞–≤—Ç–æ–Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π

```bash
# 1. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ .env –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
cat backend/.env
# AUTO_SETUP_WEBHOOK=true
# BACKEND_URL=https://myapp.com
# ...

# 2. –°–æ–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç
cd backend && npm run build

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ
pm2 start ecosystem.config.js

# 4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
pm2 logs backend
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: ‚úÖ Webhook auto-configured successfully

# 5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ health
curl https://myapp.com/health
```

### –ü—Ä–∏–º–µ—Ä 2: Development –±–µ–∑ –∞–≤—Ç–æ–Ω–∞—Å—Ç—Ä–æ–π–∫–∏

```bash
# 1. –í .env
# AUTO_SETUP_WEBHOOK=false (–∏–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ)
# BACKEND_URL=http://localhost:4000

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ dev —Å–µ—Ä–≤–µ—Ä
npm run dev

# 3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ webhook —Å ngrok URL –≤—Ä—É—á–Ω—É—é
ngrok http 4000
# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ ngrok URL

# 4. –û–±–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –≤—Ä–µ–º–µ–Ω–Ω–æ
export BACKEND_URL=https://abc123.ngrok.io

# 5. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ webhook
npm run webhook:setup
```

## –°–º. —Ç–∞–∫–∂–µ

- [WEBHOOK_SETUP.md](../WEBHOOK_SETUP.md) - –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ
- [backend/README.md](../backend/README.md) - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è backend
- [DEPLOYMENT.md](DEPLOYMENT.md) - –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –¥–µ–ø–ª–æ—é
